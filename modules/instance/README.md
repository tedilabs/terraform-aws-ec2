# instance

This module creates following resources.

- `aws_instance` (optional)
- `aws_spot_instance_request` (optional)
- `aws_eip_association` (optional)
- `aws_ami_from_instance` (optional)
- `aws_iam_role` (optional)
- `aws_iam_role_policy` (optional)
- `aws_iam_role_policy_attachment` (optional)
- `aws_iam_instance_profile` (optional)

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 4.61 |
| <a name="requirement_cloudinit"></a> [cloudinit](#requirement\_cloudinit) | >= 2.2 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | 4.52.0 |
| <a name="provider_cloudinit"></a> [cloudinit](#provider\_cloudinit) | 2.2.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_instance_profile"></a> [instance\_profile](#module\_instance\_profile) | tedilabs/account/aws//modules/iam-role | ~> 0.22.0 |
| <a name="module_resource_group"></a> [resource\_group](#module\_resource\_group) | tedilabs/misc/aws//modules/resource-group | ~> 0.10.0 |

## Resources

| Name | Type |
|------|------|
| [aws_ami_from_instance.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ami_from_instance) | resource |
| [aws_ec2_instance_state.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ec2_instance_state) | resource |
| [aws_eip_association.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eip_association) | resource |
| [aws_instance.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance) | resource |
| [aws_spot_instance_request.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/spot_instance_request) | resource |
| [aws_instance.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/instance) | data source |
| [cloudinit_config.this](https://registry.terraform.io/providers/hashicorp/cloudinit/latest/docs/data-sources/config) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_name"></a> [name](#input\_name) | (Required) The name of the instance. | `string` | n/a | yes |
| <a name="input_ami"></a> [ami](#input\_ami) | (Optional) The AMI to run on the instance. | `string` | `null` | no |
| <a name="input_ami_snapshots"></a> [ami\_snapshots](#input\_ami\_snapshots) | (Optional) A list of names for AMI snapshots of the instance. Each name should be a region-unique name for the AMI. | `set(string)` | `[]` | no |
| <a name="input_ami_snapshots_without_reboot_enabled"></a> [ami\_snapshots\_without\_reboot\_enabled](#input\_ami\_snapshots\_without\_reboot\_enabled) | (Optional) Whether to overrides the behavior of stopping the instance before snapshotting. This is risky since it may cause a snapshot of an inconsistent filesystem state, but can be used to avoid downtime if the user otherwise guarantees that no filesystem writes will be underway at the time of snapshot. | `bool` | `true` | no |
| <a name="input_auto_assign_public_ip_enabled"></a> [auto\_assign\_public\_ip\_enabled](#input\_auto\_assign\_public\_ip\_enabled) | (Optional) Whether a public IP address is automatically assigned to the primary network interface of the instance in a VPC. | `bool` | `null` | no |
| <a name="input_auto_recovery_enabled"></a> [auto\_recovery\_enabled](#input\_auto\_recovery\_enabled) | (Optional) Whether to enable auto-recovery for the instance. Instance auto-recovery recovers your instance if system status checks fail. By default, shared tenancy without local storage and GPUs are set to auto-recover. | `bool` | `null` | no |
| <a name="input_availability_zone"></a> [availability\_zone](#input\_availability\_zone) | (Optional) AZ (Availability Zone) to create the instance in. | `string` | `null` | no |
| <a name="input_cpu_credit_specification"></a> [cpu\_credit\_specification](#input\_cpu\_credit\_specification) | (Optional) The specification for CPU credit. A credit specification is only available for T2, T3, and T3a instances. Valid values are `STANDARD` or `UNLIMITED`. T3 instances are launched as `UNLIMITED` by default. T2 instances are launched as `STANDARD` by default. | `string` | `null` | no |
| <a name="input_cpu_options"></a> [cpu\_options](#input\_cpu\_options) | (Optional) The configuration of the CPU options to optimize the instance for specific workloads or business needs. You can specify these CPU options during instance launch. There is no additional or reduced charge for specifying CPU options. `cpu_options` block as defined below.<br>    (Optional) `core_count` - Sets the number of CPU cores for an instance. This option is only supported on creation of instance type that support CPU Options CPU Cores and Threads Per CPU Core Per Instance Type - specifying this option for unsupported instance types will return an error from the EC2 API.<br>    (Optional) `threads_per_core` - Set the number of CPU threads per core for the instance. If set to to 1, hyperthreading is disabled on the launched instance. | <pre>object({<br>    core_count       = number<br>    threads_per_core = number<br>  })</pre> | `null` | no |
| <a name="input_custom_instance_profile"></a> [custom\_instance\_profile](#input\_custom\_instance\_profile) | (Optional) The IAM Instance Profile to replace the default instance profile which is managed by this module. Specified as the name of the Instance Profile. Ensure your credentials have the correct permission to assign the instance profile according to the EC2 documentation, notably `iam:PassRole`. | `string` | `null` | no |
| <a name="input_dns_resource_name_ipv4_enabled"></a> [dns\_resource\_name\_ipv4\_enabled](#input\_dns\_resource\_name\_ipv4\_enabled) | (Optional) Whether to resolve the IPv4 address of the EC2 instance for requests to your resource-name based domain. | `bool` | `null` | no |
| <a name="input_dns_resource_name_ipv6_enabled"></a> [dns\_resource\_name\_ipv6\_enabled](#input\_dns\_resource\_name\_ipv6\_enabled) | (Optional) Whether to resolve the IPv6 address of the EC2 instance for requests to your resource-name based domain. | `bool` | `null` | no |
| <a name="input_ebs_optimized"></a> [ebs\_optimized](#input\_ebs\_optimized) | (Optional) Whether to enable additional, dedicated throughput between Amazon EC2 and Amazon EBS. The launched EC2 instance will be EBS-optimized if true. Note that if this is not set on an instance type that is optimized by default then this will show as disabled but if the instance type is optimized by default then there is no need to set this and there is no effect to disabling it. | `bool` | `null` | no |
| <a name="input_eip_associations"></a> [eip\_associations](#input\_eip\_associations) | (Optional) A list of configurations to associate Elastic IPs to the network interfaces of the instance. Each `eip_associations` block as defined below.<br>    (Required) `eip` - The allocation ID of Elastic IP to associate.<br>    (Optional) `private_ip` - The primary or secondary private IP address to associate with the Elastic IP address. If no private IP address is specified, the Elastic IP address is associated with the primary private IP address. | `list(map(string))` | `[]` | no |
| <a name="input_host_id"></a> [host\_id](#input\_host\_id) | (Optional) The ID of a dedicated host that the instance will be assigned to. Use when an instance is to be launched on a specific dedicated host. | `string` | `null` | no |
| <a name="input_hostname_type"></a> [hostname\_type](#input\_hostname\_type) | (Optional) The type of hostname for the EC2 instances. For IPv4 only subnets, an instance DNS name must be based on the instance IPv4 address. For IPv6 native subnets, an instance DNS name must be based on the instance ID. For dual-stack subnets, you can specify whether DNS names use the instance IPv4 address or the instance ID. Valid values are `IP_V4` and `RESOURCE_NAME`. | `string` | `null` | no |
| <a name="input_instance_profile"></a> [instance\_profile](#input\_instance\_profile) | (Optional) The configuration for the default instance profile of the instance. `instance_profile` block as defined below.<br>    (Optional) `enabled` - Whether to trigger a destroy and recreate when user data is changed. Defaults to `false`.<br>    (Optional) `name` - The name for the IAM role.<br>    (Optional) `path` - The path for the IAM role.<br>    (Optional) `description` - The description of the role.<br>    (Optional) `assumable_roles` - List of IAM roles ARNs which can be assumed by the role.<br>    (Optional) `policies` - List of IAM policies ARNs to attach to IAM role.<br>    (Optional) `inline_policies` - Map of inline IAM policies to attach to IAM role. (`name` => `policy`). | `any` | `null` | no |
| <a name="input_instance_store_volumes"></a> [instance\_store\_volumes](#input\_instance\_store\_volumes) | (Optional) The configuration for instance store volumes (also known as ephemeral volumes) of the instance. This is only required non-NVME instance store volumes (for old generation EC2 instance types). Each item of `instance_store_volumes` as defined below.<br>    (Required) `device_name` - The device name of the instance store to mount on the instance. For example, `/dev/sdh` or `xvdh`.<br>    (Optional) `virtual_name` - The virtual device name (ephemeral N). Instance store volumes are numbered starting from 0. An instance type with 2 available instance store volumes can specify mappings for ephemeral0 and ephemeral1. The number of available instance store volumes depends on the instance type. After you connect to the instance, you must mount the volume.<br>    (Optional) `no_device` - Whether to suppress the specified device included in the AMI's block device mapping. Defaults to `false`. | `any` | `[]` | no |
| <a name="input_launch_template"></a> [launch\_template](#input\_launch\_template) | (Optional) The configuration for launch template of the instance. Launch Template parameters will be used only once during instance creation. If you want to update existing instance you need to change parameters directly. Updating Launch Template specification will force a new instance. Any other instance parameters that you specify will override the same parameters in the launch template. `launch_template` block as defined below.<br>    (Optional) `id` - The ID of the launch template. Conflicts with `name`.<br>    (Optional) `name` - The name of the launch template. Conflicts with `id`.<br>    (Optional) `version` - The version of launch template. Valid value is a specific version number, `$Latest` or `$Default`. Defaults to `$Default`. | `map(string)` | `null` | no |
| <a name="input_metadata_options"></a> [metadata\_options](#input\_metadata\_options) | (Optional) The configuration for metadata of the instance. `metadata_options` block as defined below.<br>    (Optional) `http_enabled` - Whether the metadata service is available. You can turn off access to your instance metadata by disabling the HTTP endpoint of the instance metadata service. Defaults to `true`.<br>    (Optional) `http_token_required` - Whether or not the metadata service requires session tokens, also referred to as Instance Metadata Service Version 2 (IMDSv2). Defaults to `false`.<br>    (Optional) `http_put_response_hop_limit` - A desired HTTP PUT response hop limit for instance metadata requests. The larger the number, the further instance metadata requests can travel. Valid values are integer from `1` to `64`. Defaults to `1`.<br>    (Optional) `instance_tags_enabled` - Whether to enable the access to instance tags from the instance metadata service. Defaults to `false`. | `any` | `null` | no |
| <a name="input_module_tags_enabled"></a> [module\_tags\_enabled](#input\_module\_tags\_enabled) | (Optional) Whether to create AWS Resource Tags for the module informations. | `bool` | `true` | no |
| <a name="input_monitoring_enabled"></a> [monitoring\_enabled](#input\_monitoring\_enabled) | (Optional) If true, the launched EC2 instance will have detailed monitoring enabled. | `bool` | `null` | no |
| <a name="input_nitro_enclave_enabled"></a> [nitro\_enclave\_enabled](#input\_nitro\_enclave\_enabled) | (Optional) Whether to enable Nitro Enclaves on the instance. A Nitro Enclave is a trusted execution environment (TEE) in which you can securely process sensitive data. It extends the security and isolation characteristics of the AWS Nitro System and allows you to create isolated compute environments within Amazon EC2 instances. Defaults to `false`. | `bool` | `null` | no |
| <a name="input_placement_group"></a> [placement\_group](#input\_placement\_group) | (Optional) The name of the placement group to start the instance in, if applicable. Choose an instance type that supports enhanced networking to use `CLUSTER` placement group. You cannot launch Dedicated Hosts in placement groups. | `string` | `null` | no |
| <a name="input_placement_group_partition"></a> [placement\_group\_partition](#input\_placement\_group\_partition) | (Optional) The index of the partition the instance is in. Valid only if the `placement_group` resource's strategy is set to `PARTITION`. | `number` | `null` | no |
| <a name="input_private_ip"></a> [private\_ip](#input\_private\_ip) | (Optional) The primary private IPv4 address to associate with the instance. | `string` | `null` | no |
| <a name="input_resource_group_description"></a> [resource\_group\_description](#input\_resource\_group\_description) | (Optional) The description of Resource Group. | `string` | `"Managed by Terraform."` | no |
| <a name="input_resource_group_enabled"></a> [resource\_group\_enabled](#input\_resource\_group\_enabled) | (Optional) Whether to create Resource Group to find and group AWS resources which are created by this module. | `bool` | `true` | no |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | (Optional) The name of Resource Group. A Resource Group name can have a maximum of 127 characters, including letters, numbers, hyphens, dots, and underscores. The name cannot start with `AWS` or `aws`. | `string` | `""` | no |
| <a name="input_root_volume"></a> [root\_volume](#input\_root\_volume) | (Optional) The configuration for root volume (root block device) of the instance. `root_volume` block as defined below.<br>    (Optional) `type` - The type of volume to attach.<br>    (Optional) `size` - The size of the volume, in GiB. If you are creating the volume from a snapshot, then the size of the volume can’t be smaller than the size of the snapshot.<br>    (Optional) `provisioned_iops` - The amount of provisioned IOPS. Only valid for type of `io1`, `io2` or `gp3`.<br>    (Optional) `provisioned_throughput` - Throughput to provision for a volume in mebibytes per second (MiB/s). This is only valid for type of `gp3`.<br>    (Optional) `encryption_enabled` - Whether to enable volume encryption. Defaults to `false`.<br>    (Optional) `encryption_kms_key` - The ARN(Amazon Resource Name) of the KMS Key to use when encrypting the volume.<br>    (Optional) `delete_on_termination` - Whether the volume should be destroyed on instance termination. Defaults to `true`.<br>    (Optional) `tags` - A map of tags to assign to the device. | `any` | `{}` | no |
| <a name="input_secondary_private_ips"></a> [secondary\_private\_ips](#input\_secondary\_private\_ips) | (Optional) A list of secondary private IPv4 addresses to assign to the instance's primary network interface (eth0). Can only be assigned to the primary network interface (eth0) attached at instance creation, not a pre-existing network interface i.e., referenced in a network\_interface block. | `set(string)` | `null` | no |
| <a name="input_security_groups"></a> [security\_groups](#input\_security\_groups) | (Optional) A set of security group IDs to assign to the instance. | `set(string)` | `[]` | no |
| <a name="input_shutdown_behavior"></a> [shutdown\_behavior](#input\_shutdown\_behavior) | (Optional) The instance behavior when an OS-level shutdown is performed. Instances can be either terminated or stopped. Valid values are `STOP` or `TERMINATE`. Amazon defaults this to `STOP` for EBS-backed instances and `TERMINATE` for instance-store instances. Cannot be set on instance-store instances. | `string` | `null` | no |
| <a name="input_source_dest_check_enabled"></a> [source\_dest\_check\_enabled](#input\_source\_dest\_check\_enabled) | (Optional) Whether the traffic is routed to the instance when the destination address does not match the instance. Used for NAT or VPNs. Defaults to `true`. | `bool` | `null` | no |
| <a name="input_spot_enabled"></a> [spot\_enabled](#input\_spot\_enabled) | (Optional) Whether to create the instance as a spot instance. | `bool` | `false` | no |
| <a name="input_ssh_key"></a> [ssh\_key](#input\_ssh\_key) | (Optional) The name of the SSH Key that should be used to access the instance. | `string` | `null` | no |
| <a name="input_state"></a> [state](#input\_state) | (Optional) The state of the instance. Valid values are `RUNNING`, `STOPPED` or `FORCED_STOP`. | `string` | `"RUNNING"` | no |
| <a name="input_stop_hibernation_enabled"></a> [stop\_hibernation\_enabled](#input\_stop\_hibernation\_enabled) | (Optional) Indicates whether to support hibernation stop for the instance. Hibernation stops your instance and saves the contents of the instance’s RAM to the root volume. You cannot enable hibernation after launch. | `bool` | `null` | no |
| <a name="input_stop_protection_enabled"></a> [stop\_protection\_enabled](#input\_stop\_protection\_enabled) | (Optional) Indicates whether stop of the instance via the AWS API will be protected. Defaults to `false`. | `bool` | `false` | no |
| <a name="input_subnet_id"></a> [subnet\_id](#input\_subnet\_id) | (Optional) The ID of subnet in which to launch the instance. | `string` | `null` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | (Optional) A map of tags to add to all resources. | `map(string)` | `{}` | no |
| <a name="input_tenancy"></a> [tenancy](#input\_tenancy) | (Optional) The tenancy of the instance (if the instance is running in a VPC). Valid values are `DEFAULT`, `DEDICATED` or `HOST`. | `string` | `null` | no |
| <a name="input_termination_protection_enabled"></a> [termination\_protection\_enabled](#input\_termination\_protection\_enabled) | (Optional) Indicates whether termination of the instance via the AWS API will be protected. Defaults to `false`. | `bool` | `false` | no |
| <a name="input_timeouts"></a> [timeouts](#input\_timeouts) | (Optional) How long to wait for the instance to be created/updated/deleted. | `map(string)` | <pre>{<br>  "create": "10m",<br>  "delete": "20m",<br>  "update": "10m"<br>}</pre> | no |
| <a name="input_type"></a> [type](#input\_type) | (Optional) The instance type to use for the instance. Updates to this field will trigger a stop/start of the EC2 instance. | `string` | `null` | no |
| <a name="input_user_data"></a> [user\_data](#input\_user\_data) | (Optional) The configuration for metadata of the instance. `metadata_options` block as defined below.<br>    (Optional) `replace_on_change` - Whether to trigger a destroy and recreate when user data is changed. Defaults to `false`.<br>    (Optional) `encoding` - A method to encode the content of user-data to delivery. Valid values are `PLAINTEXT`, `BASE64` or `BASE64_GZIP`. Defaults to `PLAINTEXT`.<br>    (Optional) `content` - A content of user-data for shell script or cloud-config. Only required if `mime_enabled` is `false`.<br>    (Optional) `mime_enabled` - Whether to use Multipart MIME for the user-data format. Defaults to `false`.<br>    (Optional) `mime_parts` - A list of parts to produce multipart MIME messages of cloud-init. Only required if `mime_enabled` is `true`. Each item of `mime_parts` as defined below.<br>      (Required) `content` - A body content for the part.<br>      (Optional) `content_type` - A MIME-style content type to report in the header for the part. Valid values are `cloud-boothook`, `cloud-config`, `cloud-config-archive`, `cloud-cnofig-jsonp`, `jinja2`, `part-handler`, `x-include-once-url`, `x-include-url`, `x-shellscript`, `x-shellscript-per-boot`, `x-shellscript-per-instance`, `x-shellscript-per-once`.<br>      (Optional) `merge_type` - A value for the `X-Merge-Type` header of the part, to control cloud-init merging behavior.<br>      (Optional) `filename` - A filename to report in the header for the part. | `any` | `{}` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_ami"></a> [ami](#output\_ami) | The AMI to run on the instance. |
| <a name="output_ami_snapshots"></a> [ami\_snapshots](#output\_ami\_snapshots) | The configuration of AMI snapshots for the instance. |
| <a name="output_arn"></a> [arn](#output\_arn) | The ARN of the instance. |
| <a name="output_attributes"></a> [attributes](#output\_attributes) | A set of attributes that applied to the instance. |
| <a name="output_cpu"></a> [cpu](#output\_cpu) | The CPU configuration for the instance.<br>    `options` - The CPU options for the instance.<br>    `credit_specification` - The CPU credit specification for the instance. |
| <a name="output_host"></a> [host](#output\_host) | The configuration of host and placement group for the instance. |
| <a name="output_id"></a> [id](#output\_id) | The ID of the instance. |
| <a name="output_instance_profile"></a> [instance\_profile](#output\_instance\_profile) | The IAM Instance Profile of the instance. |
| <a name="output_launch_template"></a> [launch\_template](#output\_launch\_template) | The configuration for launch template of the instance. |
| <a name="output_metadata"></a> [metadata](#output\_metadata) | The configuration for metadata of the instance. |
| <a name="output_name"></a> [name](#output\_name) | The name of the instance. |
| <a name="output_network"></a> [network](#output\_network) | The network configuration for the instance.<br>    `availability_zone` - The Availability Zone of the instance.<br>    `subnet_id` - The ID of subnet of the launched instance.<br>    `source_dest_check_enabled` - Whether the traffic is routed to the instance when the destination address does not match the instance.<br><br>    `public_ip` - The public IP address assigned to the instance, if applicable. NOTE: If you are using an aws\_eip with your instance, you should refer to the EIP's address directly and not use `public_ip` as this field will change after the EIP is attached.<br>    `private_ip` - The private IP address assigned to the instance.<br>    `secondary_private_ips` - A list of secondary private IPv4 addresses assigned to the instance's primary network interface.<br><br>    `public_domain` - The public DNS name assigned to the instance. For EC2-VPC, this is only available if you've enabled DNS hostnames for your VPC.<br>    `private_domain` - The private DNS name assigned to the instance. Can only be used inside the Amazon EC2, and only available if you've enabled DNS hostnames for your VPC.<br>    `hostname_type` - The type of hostname for the EC2 instances.<br>    `dns_resource_name_ipv4_enabled` - Whether to resolve the IPv4 address of the EC2 instance for requests to your resource-name based domain.<br>    `dns_resource_name_ipv6_enabled` - Whether to resolve the IPv6 address of the EC2 instance for requests to your resource-name based domain. |
| <a name="output_ssh_key"></a> [ssh\_key](#output\_ssh\_key) | The name of the SSH Key to access the instance. |
| <a name="output_state"></a> [state](#output\_state) | The state of the instance. One of: `PENDING`, `RUNNING`, `STOPPING`, `STOPPED`, `SHUTTING_DOWN`, `TERMINATED`. |
| <a name="output_storage"></a> [storage](#output\_storage) | The configuration of storage for the instance. |
| <a name="output_type"></a> [type](#output\_type) | The instance type to use for the instance. |
| <a name="output_user_data"></a> [user\_data](#output\_user\_data) | The configuration for user-data of the instance. |
| <a name="output_zzz"></a> [zzz](#output\_zzz) | The configuration of rule groups associated with the firewall. |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
